# GitHub Actions å·¥ä½œæµï¼šæ„å»ºå’Œæ¨é€ PostgreSQL Docker é•œåƒ
# è¯¥å·¥ä½œæµä¸“é—¨ç”¨äºæ„å»º postgres-appliance (Spilo) Docker é•œåƒå¹¶æ¨é€åˆ° Docker Hub
# æ”¯æŒå¤šæ¶æ„æ„å»ºã€ç¼“å­˜ä¼˜åŒ–ã€å®‰å…¨æ‰«æå’Œè¯¦ç»†çš„æ„å»ºä¿¡æ¯è¾“å‡º
#
# ä½¿ç”¨è¯´æ˜ï¼š
# 1. ç¡®ä¿åœ¨ GitHub Secrets ä¸­é…ç½®äº† DOCKER_USERNAME å’Œ DOCKER_PASSWORD
# 2. DOCKER_USERNAME åº”è¯¥æœ‰æ¨é€åˆ° alpen12/pgsql ä»“åº“çš„æƒé™
# 3. æ‰‹åŠ¨è§¦å‘å·¥ä½œæµè¿›è¡Œæ„å»ºå’Œæ¨é€
#
# æ³¨æ„äº‹é¡¹ï¼š
# - æ„å»ºæ—¶é—´è¾ƒé•¿ï¼ˆå¤šæ¶æ„æ„å»ºéœ€è¦ 20-40 åˆ†é’Ÿï¼‰
# - éœ€è¦è¶³å¤Ÿçš„ GitHub Actions è¿è¡Œæ—¶é—´é…é¢
# - ç¡®ä¿ Docker Hub ä»“åº“å­˜åœ¨ä¸”æœ‰æ¨é€æƒé™

name: æ„å»ºå’Œæ¨é€ PostgreSQL Docker é•œåƒ

# è§¦å‘æ¡ä»¶ï¼šä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'è‡ªå®šä¹‰é•œåƒæ ‡ç­¾ï¼ˆé»˜è®¤ä½¿ç”¨latestå’Œåˆ†æ”¯åï¼‰'
        required: false
        default: 'latest'
        type: string
      build_platforms:
        description: 'æ„å»ºå¹³å°æ¶æ„'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: choice
        options:
          - 'linux/amd64,linux/arm64'
          - 'linux/amd64'
          - 'linux/arm64'
      enable_security_scan:
        description: 'å¯ç”¨é•œåƒå®‰å…¨æ‰«æ'
        required: false
        default: true
        type: boolean
      push_to_registry:
        description: 'æ¨é€åˆ° Docker Hubï¼ˆå–æ¶ˆå‹¾é€‰ä»…æ„å»ºä¸æ¨é€ï¼‰'
        required: false
        default: true
        type: boolean

# å®šä¹‰ç¯å¢ƒå˜é‡
env:
  # Docker Hub é•œåƒä»“åº“åç§° - ç¡®ä¿ä¸å®é™…æ¨é€ç›®æ ‡ä¸€è‡´
  DOCKER_REPOSITORY: alpen12/pgsql
  # Docker é•œåƒæ ‡ç­¾ - æ”¯æŒæ‰‹åŠ¨è¾“å…¥æˆ–è‡ªåŠ¨ç”Ÿæˆ
  IMAGE_TAG: ${{ github.event.inputs.image_tag || 'latest' }}
  # Dockerfile æ‰€åœ¨ç›®å½•
  DOCKER_CONTEXT: ./postgres-appliance
  # æ„å»ºå¹³å°æ¶æ„ - æ”¯æŒæ‰‹åŠ¨é€‰æ‹©æˆ–é»˜è®¤å¤šæ¶æ„
  BUILD_PLATFORMS: ${{ github.event.inputs.build_platforms || 'linux/amd64,linux/arm64' }}
  # æ˜¯å¦æ¨é€åˆ°ä»“åº“ - æ”¯æŒä»…æ„å»ºä¸æ¨é€çš„é€‰é¡¹
  PUSH_ENABLED: ${{ github.event.inputs.push_to_registry != 'false' && 'true' || 'false' }}
  # æ˜¯å¦å¯ç”¨å®‰å…¨æ‰«æ
  SECURITY_SCAN_ENABLED: ${{ github.event.inputs.enable_security_scan != 'false' && 'true' || 'false' }}

jobs:
  # æ„å»ºå’Œæ¨é€ Docker é•œåƒçš„ä½œä¸š
  build-and-push:
    name: æ„å»ºå’Œæ¨é€é•œåƒ
    # åœ¨ Ubuntu æœ€æ–°ç‰ˆæœ¬ä¸Šè¿è¡Œ
    runs-on: ubuntu-latest
    
    steps:
    # ç¬¬1æ­¥ï¼šæ£€å‡ºä»£ç ä»“åº“
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        # è·å–å®Œæ•´çš„ Git å†å²ï¼Œç”¨äºç‰ˆæœ¬æ ‡è®°
        fetch-depth: 0
    
    # ç¬¬2æ­¥ï¼šè®¾ç½® Docker Buildxï¼ˆæ”¯æŒå¤šå¹³å°æ„å»ºï¼‰
    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        # å¯ç”¨é«˜çº§åŠŸèƒ½
        driver-opts: image=moby/buildkit:buildx-stable-1
    
    # ç¬¬3æ­¥ï¼šç™»å½•åˆ° Docker Hub
    - name: ç™»å½• Docker Hub
      uses: docker/login-action@v3
      with:
        # ä½¿ç”¨ GitHub Secrets ä¸­çš„ Docker Hub å‡­æ®
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    # ç¬¬4æ­¥ï¼šæå–å…ƒæ•°æ®ï¼ˆæ ‡ç­¾å’Œæ³¨é‡Šï¼‰
    - name: æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        # é•œåƒåç§° - ä½¿ç”¨ç¯å¢ƒå˜é‡ç¡®ä¿ä¸€è‡´æ€§
        images: ${{ env.DOCKER_REPOSITORY }}
        # æ ‡ç­¾è§„åˆ™ - æ”¯æŒå¤šç§æ ‡ç­¾ç­–ç•¥
        tags: |
          # ä½¿ç”¨ latest ä½œä¸ºé»˜è®¤æ ‡ç­¾
          type=raw,value=latest
          # åŸºäºåˆ†æ”¯åç§°çš„æ ‡ç­¾ï¼ˆå¦‚æœéœ€è¦ï¼‰
          type=ref,event=branch
          # åŸºäºæ ‡ç­¾çš„ç‰ˆæœ¬å·ï¼ˆå¦‚æœæœ‰Gitæ ‡ç­¾ï¼‰
          type=ref,event=tag
          # åŸºäºæäº¤SHAçš„çŸ­æ ‡ç­¾ï¼ˆç”¨äºè°ƒè¯•ï¼‰
          type=sha,prefix={{branch}}-
    
    # ç¬¬5æ­¥ï¼šæ„å»ºå’Œæ¨é€ Docker é•œåƒ
    - name: æ„å»ºå’Œæ¨é€é•œåƒ
      uses: docker/build-push-action@v5
      with:
        # æŒ‡å®š Dockerfile æ‰€åœ¨çš„ä¸Šä¸‹æ–‡è·¯å¾„ - ä½¿ç”¨ç¯å¢ƒå˜é‡
        context: ${{ env.DOCKER_CONTEXT }}
        # Dockerfile è·¯å¾„ - æ˜ç¡®æŒ‡å®šDockerfileä½ç½®
        file: ${{ env.DOCKER_CONTEXT }}/Dockerfile
        # æ¨é€åˆ°è¿œç¨‹ä»“åº“ - æ ¹æ®è¾“å…¥å‚æ•°å†³å®šæ˜¯å¦æ¨é€
        push: ${{ env.PUSH_ENABLED == 'true' }}
        # ä½¿ç”¨å¤šå¹³å°æ„å»º - æ”¯æŒAMD64å’ŒARM64æ¶æ„
        platforms: ${{ env.BUILD_PLATFORMS }}
        # ä½¿ç”¨ä»å…ƒæ•°æ®æ­¥éª¤è·å–çš„æ ‡ç­¾ - ç¡®ä¿æ ‡ç­¾ä¸€è‡´æ€§
        tags: ${{ steps.meta.outputs.tags }}
        # ä½¿ç”¨ä»å…ƒæ•°æ®æ­¥éª¤è·å–çš„æ ‡æ³¨ - åŒ…å«æ„å»ºä¿¡æ¯
        labels: ${{ steps.meta.outputs.labels }}
        # æ„å»ºå‚æ•° - å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªå®šä¹‰æ„å»ºå‚æ•°
        build-args: |
          BUILD_DATE=${{ steps.meta.outputs.labels['org.opencontainers.image.created'] }}
          VCS_REF=${{ github.sha }}
        # å¯ç”¨ GitHub Actions ç¼“å­˜ä»¥åŠ é€Ÿæ„å»º
        cache-from: type=gha
        cache-to: type=gha,mode=max
        # å¯ç”¨æ„å»ºè¾“å‡ºä»¥ä¾¿è°ƒè¯•
        outputs: type=registry
    
    # ç¬¬6æ­¥ï¼šè¾“å‡ºæ„å»ºä¿¡æ¯å’ŒéªŒè¯ç»“æœ
    - name: è¾“å‡ºæ„å»ºä¿¡æ¯
      run: |
        echo "ğŸ‰ Docker é•œåƒæ„å»ºå®Œæˆï¼"
        echo "ğŸ“‹ æ„å»ºè¯¦ç»†ä¿¡æ¯:"
        echo "   - ä»“åº“åç§°: ${{ env.DOCKER_REPOSITORY }}"
        echo "   - æ„å»ºæ ‡ç­¾: ${{ steps.meta.outputs.tags }}"
        echo "   - æ”¯æŒå¹³å°: ${{ env.BUILD_PLATFORMS }}"
        echo "   - æ„å»ºä¸Šä¸‹æ–‡: ${{ env.DOCKER_CONTEXT }}"
        echo "   - æäº¤ SHA: ${{ github.sha }}"
        echo "   - æ„å»ºæ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        echo ""
        echo "ğŸš€ é•œåƒå·²æˆåŠŸæ¨é€åˆ° Docker Hub"
        echo "ğŸ’¡ æ‹‰å–å‘½ä»¤ç¤ºä¾‹:"
        echo "   docker pull ${{ env.DOCKER_REPOSITORY }}:latest"
        echo "   docker pull ${{ env.DOCKER_REPOSITORY }}:${{ github.ref_name }}"
        echo ""
        echo "ğŸ” é•œåƒè¯¦æƒ…å¯åœ¨ä»¥ä¸‹åœ°å€æŸ¥çœ‹:"
        echo "   https://hub.docker.com/r/${{ env.DOCKER_REPOSITORY }}/tags"
    
    # ç¬¬7æ­¥ï¼šé•œåƒå®‰å…¨æ‰«æï¼ˆå¯é€‰ï¼Œæ¨èå¯ç”¨ï¼‰
    - name: é•œåƒå®‰å…¨æ‰«æ
      uses: docker/scout-action@v1
      if: ${{ env.SECURITY_SCAN_ENABLED == 'true' && env.PUSH_ENABLED == 'true' }}
      with:
        command: cves
        image: ${{ env.DOCKER_REPOSITORY }}:${{ env.IMAGE_TAG }}
        only-severities: critical,high
        exit-code: false  # ä¸å› ä¸ºå®‰å…¨é—®é¢˜è€Œç»ˆæ­¢å·¥ä½œæµ
      continue-on-error: true  # æ‰«æå¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹
    
    # ç¬¬8æ­¥ï¼šæ¸…ç†æ„å»ºç¼“å­˜ï¼ˆå¯é€‰ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´ï¼‰
    - name: æ¸…ç†æ„å»ºç¼“å­˜
      if: ${{ github.event_name == 'workflow_dispatch' }}
      run: |
        echo "ğŸ§¹ æ¸…ç† Docker æ„å»ºç¼“å­˜..."
        docker builder prune -f --filter until=24h || true
        echo "âœ… ç¼“å­˜æ¸…ç†å®Œæˆ"
