# GitHub Actions å·¥ä½œæµï¼šæ„å»ºå’Œæ¨é€ Docker é•œåƒåˆ° Docker Hub
# è¯¥å·¥ä½œæµæ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼Œç”¨äºæ„å»º postgres-appliance Docker é•œåƒ

name: æ„å»ºå’Œæ¨é€ Docker é•œåƒ

# è§¦å‘æ¡ä»¶ï¼šä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:

# å®šä¹‰ç¯å¢ƒå˜é‡
env:
  # Docker Hub é•œåƒä»“åº“åç§°ï¼ˆéœ€è¦æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
  DOCKER_REPOSITORY: alpen12/pgsql
  # Docker é•œåƒæ ‡ç­¾
  IMAGE_TAG: latest

jobs:
  # æ„å»ºå’Œæ¨é€ Docker é•œåƒçš„ä½œä¸š
  build-and-push:
    name: æ„å»ºå’Œæ¨é€é•œåƒ
    # åœ¨ Ubuntu æœ€æ–°ç‰ˆæœ¬ä¸Šè¿è¡Œ
    runs-on: ubuntu-latest
    
    steps:
    # ç¬¬1æ­¥ï¼šæ£€å‡ºä»£ç ä»“åº“
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        # è·å–å®Œæ•´çš„ Git å†å²ï¼Œç”¨äºç‰ˆæœ¬æ ‡è®°
        fetch-depth: 0
    
    # ç¬¬2æ­¥ï¼šè®¾ç½® Docker Buildxï¼ˆæ”¯æŒå¤šå¹³å°æ„å»ºï¼‰
    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        # å¯ç”¨é«˜çº§åŠŸèƒ½
        driver-opts: image=moby/buildkit:buildx-stable-1
    
    # ç¬¬3æ­¥ï¼šç™»å½•åˆ° Docker Hub
    - name: ç™»å½• Docker Hub
      uses: docker/login-action@v3
      with:
        # ä½¿ç”¨ GitHub Secrets ä¸­çš„ Docker Hub å‡­æ®
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    # ç¬¬4æ­¥ï¼šæå–å…ƒæ•°æ®ï¼ˆæ ‡ç­¾å’Œæ³¨é‡Šï¼‰
    - name: æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        # é•œåƒåç§°
        images: ${{ env.DOCKER_REPOSITORY }}
        # æ ‡ç­¾è§„åˆ™
        tags: |
          # ä½¿ç”¨ latest ä½œä¸ºæ ‡ç­¾
          type=raw,value=latest
    
    # ç¬¬5æ­¥ï¼šæ„å»ºå’Œæ¨é€ Docker é•œåƒ
    - name: æ„å»ºå’Œæ¨é€é•œåƒ
      uses: docker/build-push-action@v5
      with:
        # æŒ‡å®š Dockerfile æ‰€åœ¨çš„ä¸Šä¸‹æ–‡è·¯å¾„
        context: ./postgres-appliance
        # Dockerfile è·¯å¾„
        file: ./postgres-appliance/Dockerfile
        # æ¨é€åˆ°è¿œç¨‹ä»“åº“
        push: true
        # ä½¿ç”¨å¤šå¹³å°æ„å»ºï¼ˆAMD64 å’Œ ARM64ï¼‰
        platforms: linux/amd64,linux/arm64
        # ä½¿ç”¨ä»å…ƒæ•°æ®æ­¥éª¤è·å–çš„æ ‡ç­¾
        tags: ${{ steps.meta.outputs.tags }}
        # ä½¿ç”¨ä»å…ƒæ•°æ®æ­¥éª¤è·å–çš„æ ‡ç­¾ä½œä¸ºæ ‡æ³¨
        labels: ${{ steps.meta.outputs.labels }}
        # æ„å»ºå‚æ•°ä½¿ç”¨ Dockerfile ä¸­çš„é»˜è®¤å€¼
        # å¯ç”¨ Docker å±‚ç¼“å­˜ä»¥åŠ é€Ÿæ„å»º
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    # ç¬¬6æ­¥ï¼šè¾“å‡ºæ„å»ºä¿¡æ¯
    - name: è¾“å‡ºæ„å»ºä¿¡æ¯
      run: |
        echo "ğŸ‰ Docker é•œåƒæ„å»ºå®Œæˆï¼"
        echo "ğŸ“‹ æ„å»ºä¿¡æ¯:"
        echo "   - ä»“åº“: ${{ env.DOCKER_REPOSITORY }}"
        echo "   - æ ‡ç­¾: ${{ env.IMAGE_TAG }}"
        echo "   - å¹³å°: linux/amd64, linux/arm64"
        echo ""
        echo "ğŸš€ é•œåƒå·²æ¨é€åˆ° Docker Hub"
        echo "ğŸ’¡ æ‹‰å–å‘½ä»¤: docker pull ${{ env.DOCKER_REPOSITORY }}:${{ env.IMAGE_TAG }}"
